<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script>
        var website = 'http://' + window.location.host;
        // var website = "http://www.ycdl.com";
        /**
         1. 禁用动态添加脚本，防止广告加载
         */
       // (function () {
           // var createElement = document.createElement;
            //document.createElement = function (tag) {
            //    switch (tag) {
            //        case 'script':
            //           console.log('禁用动态添加脚本，防止广告加载');
            //            break;
            //        default:
            //           return createElement.apply(this, arguments);
            //    }
            //}
        //})();
        var marker_self;
        var is_up_location = false;
    </script>

    <title>立即用车</title>
    <link rel="stylesheet" href="__STATIC__/mobile/css/index-css2.css?rand={$css_rand}" type="text/css">
    <link rel="stylesheet" href="__STATIC__/mobile/css/map-choose-car-css.css?rand={$css_rand}">
    <link rel="stylesheet" href="__STATIC__/mui/css/mui.min.css?rand={$css_rand}">
    <link rel="stylesheet" href="__STATIC__/mui/css/mui-icons-extra.css?rand={$css_rand}">
    <style>
        ul {
            font-size: 14px;
            color: #8f8f94;
        }

        .mui-bar {
            background-color: #ffdb30;
        }

        .mui-icon-right-nav {
            float: right;
        }

        .search_by_qrcode {
            background-image: url("../../.././public/static/mobile/images/search_by_plate.png");
            background-size: 30px, 30px;
            background-position: 5px, 5px;
            background-repeat: no-repeat;
        }

        .search_by_camera {
            background-image: url("../../.././public/static/mobile/images/car_camera.png");
            background-size: 25px, 25px;
            background-position: 5px, 5px;
            background-repeat: no-repeat;
        }

        .use_car_btn {
            background: -webkit-linear-gradient(left top, #ffbb00, #ede354); /* Safari 5.1 - 6.0 */
            background: -o-linear-gradient(bottom right, #ffbb00, #ede354); /* Opera 11.1 - 12.0 */
            background: -moz-linear-gradient(bottom right, #ffbb00, #ede354); /* Firefox 3.6 - 15 */
            background: linear-gradient(to bottom right, #ffbb00, #ede354); /* 标准的语法 */
        }

    </style>
</head>
<body>
<header class="mui-bar mui-bar-nav">
    <span id="js_user_center" style="color: white" class="mui-icon mui-icon-contact"></span>
    <h1 class="mui-title" style="color: white">立即用车</h1>

    <span id="js_car_list" style="color: white;display: block"
          class="mui-icon mui-icon-list mui-icon-right-nav"></span>
    <span id="js_rqcode_car" style="color: white;display: none"
          class="mui-icon mui-icon-extra mui-icon-extra-sweep mui-icon-right-nav"></span>
</header>
<div style="height: 30px;width: 100%;position: absolute;top: 45px;z-index:800;">

    <input id="js_search_plate" class="search_by_qrcode"
           style="border-top-right-radius:0;border-bottom-right-radius:0;padding-left: 30px;opacity: 0.8;width: 45%;height: 100%;font-size: 14px"
           type="text"
           disabled="disabled"
           placeholder="输入车牌号取车">
    <input id="js_search_by_plate" type="button" value="搜索"
           style="width: 15%;height: 100%;margin-left: -6px;opacity: 0.8;border-top-left-radius:0;border-bottom-left-radius:0;font-size: 14px">
    <input id="js_get_by_qrcode" type="button" class="search_by_camera" value="拍车牌用车"
           style="padding-left: 30px;background-color: #ffdb30;width: 30%;height: 100%;margin-left: -6px;opacity: 0.8;border-radius:5px;font-size: 14px;float: right;">
</div>
<div id="js_marker_car_pop"
     style="width: 98%;height: 140px;position:fixed;z-index: 999;background: rgba(255,255,255,0.8);bottom:55px;left: 1%;right: 1%;border-radius: 10px;display: none">
    <div class="mui-slider">
        <div class="mui-slider-group" id="js_marker_group">
            <div class="mui-slider-item js-car-item" data-index="0">
                <span class="js_marker_car_close">×</span>
                <div style="width: 100%;height: 160px">
                    <div style="width: 40%;height: 160px;float: left;">
                        <div style="width: 100%;height: 61%;float: top;">
                            <img class="js_marker_car_series_img"
                                 style="width: 90%;margin-left: 5%;padding-top: 25px"
                                 src="http://img.youchedongli.cn/public/car_show_image/X/%E6%96%B0%E8%83%BD%E6%BA%90/EC200.png?x-oss-process=image/resize,w_275">
                        </div>
                        <div class="js_marker_car_plate"
                             style="width: 100%;height: auto;float: bottom;text-align: center;padding: auto;font-size: large;margin-top: 5px">
                            贵A133CX
                        </div>
                    </div>
                    <div style="width: 59%;height: 100%;float: right;margin-left: 1%">
                        <div style="height: 20%;width: 100%;">
                            <div style="height: 40px;width: 100%;display: flex;align-items: center;vertical-align: center;">
                                <img style="height: 20px;width: 15px;"
                                     src="../../.././public/static/mobile/images/ele_flag.png">
                                <div class="loadbar">
                                    <div class="bar"></div>
                                    <div class="bar"></div>
                                    <div class="bar"></div>
                                    <div class="bar"></div>
                                    <div class="bar"></div>
                                    <div class="bar"></div>
                                    <div class="bar"></div>
                                    <div class="bar"></div>
                                    <div class="bar"></div>
                                    <div class="bar"></div>
                                </div>
                                <span style="margin-left: 2px" class="js_marker_car_driving_mileage">80公里</span>
                            </div>
                        </div>
                        <div style="height: 80%;width: 100%">
                            <div style="height: 30%;display: flex;vertical-align: center;align-items: center">
                                <span class="js_marker_car_name" style="font-size: 16px">众泰</span>
                            </div>
                            <div class="js_marker_car_tag">
                                <span style="padding: 2px 6px;border: #aaaaaa solid 1px;border-radius: 6px;font-size: 14px">4/5座</span>
                            </div>
                            <div style="margin-top: 10px;">
                                <span class="js_marker_car_price"
                                      style="color: #ff8730;font-size: 18px;font-weight: bold"></span>
                                <span> 元/小时 + </span>
                                <span class="js_marker_km_price"
                                      style="color: #ff8730;font-size: 18px;font-weight: bold"> 1</span>
                                <span> 元/公里</span>
                            </div>
                        </div>
                    </div>

                    <span class="js_marker_car_id" style="display: none"></span>
                    <span class="js_marker_car_store_id" style="display: none"></span>
                    <span class="js_marker_car_lat" style="display: none"></span>
                    <span class="js_marker_car_lng" style="display: none"></span>

                </div>
            </div>
        </div>

        <div class="js_marker_car_index" id="js_marker_index_group">
            <div class="car_index_item car_index_item_checked js_car_index_item" data-index="0"></div>
        </div>
    </div>
    <div style="width: 100%;height: 45px;position: absolute;left: 0;bottom: -50px;text-align: center;font-size: larger">
        <div class="use_car_btn js_go_navi" style="margin-right: 2%">
            <div style="width: 100%;font-size: 15px">导航去取车</div>
        </div>
        <div class="use_car_btn js_marker_car_use" style="margin-left: 2%">
            <div style="width: 100%;font-size: 15px">立即用车</div>
        </div>
    </div>
</div>
<div id="js_car_pop"
     style="width: 98%;height: 140px;position:fixed;z-index: 999;background: rgba(255,255,255,0.8);bottom:55px;left: 1%;right: 1%;border-radius: 10px;display: none;">
    <span class="js_marker_car_close">×</span>
    <div style="width: 100%;height: 160px">
        <div style="width: 40%;height: 100%;float: left;">
            <div style="width: 100%;height: 61%;float: top;">
                <img class="js_marker_car_series_img" style="width: 80%;margin-left: 10%;padding-top: 25px"
                     src="http://img.youchedongli.cn/public/car_show_image/X/%E6%96%B0%E8%83%BD%E6%BA%90/EC200.png?x-oss-process=image/resize,w_275">
            </div>
            <div class="js_marker_car_plate"
                 style="width: 100%;height: auto;float: bottom;text-align: center;padding: auto;font-size: large;margin-top: 5px">
            </div>
        </div>
        <div style="width: 59%;height: 100%;float: right;margin-left: 1%">
            <div style="height: 20%;width: 100%;">
                <div style="height: 40px;width: 100%;display: flex;align-items: center;vertical-align: center;">
                    <img style="height: 20px;width: 15px" src="../../.././public/static/mobile/images/ele_flag.png">
                    <div class="loadbar">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                    <span style="margin-left: 2px" class="js_marker_car_driving_mileage"></span>
                </div>
            </div>
            <div style="height: 80%;width: 100%">
                <div style="height: 30%;display: flex;vertical-align: center;align-items: center">
                    <span class="js_marker_car_name" style="font-size: 16px"></span>
                </div>
                <div class="js_marker_car_tag">
                    <span style="padding: 2px 6px;border: #aaaaaa solid 1px;border-radius: 6px;font-size: 14px">4/5座</span>
                </div>
                <div style="margin-top: 10px;">
                    <span class="js_marker_car_price" style="color: #ff8730;font-size: 18px;font-weight: bold"></span>
                    <span> 元/小时 + </span>
                    <span class="js_marker_km_price" style="color: #ff8730;font-size: 18px;font-weight: bold"></span>
                    <span> 元/公里</span>
                </div>
            </div>
        </div>

        <span class="js_marker_car_id" style="display: none"></span>
        <span class="js_marker_car_store_id" style="display: none"></span>
        <span class="js_marker_car_lat" style="display: none"></span>
        <span class="js_marker_car_lng" style="display: none"></span>

    </div>
    <div style="width: 100%;height: 45px;position: fixed;bottom: 2px;text-align: center;float: left;font-size: larger">
        <div id="js_go_navi" class="use_car_btn" style="margin-right: 2%">
            <div style="width: 100%;font-size: 15px">导航去取车</div>
        </div>
        <div id="js_marker_car_use" class="use_car_btn" style="margin-left: 2%">
            <div style="width: 100%;font-size: 15px">立即用车</div>
        </div>
    </div>
</div>

<div id="l-map"></div>
<div id="js_user_map_fun"
     style="width:99%; height:40px; background-color:rgba(255,255,255,0);display:flex;position: fixed;bottom: 90px;z-index: 500;justify-content:center;align-items:center;">
    <div id="js_get_refresh" class="use_car_btn"
         style="width:100px; height:100%; background-color:#f3e856; border-radius:20px;font-size: 14px;display:flex;justify-content:center;align-items:center;">
        <!--<span class="mui-icon mui-icon-camera"></span>-->
        <!--<img style="height: 20px;width: 20px" src="http://img.youchedongli.cn/public/static/mobile/images/data_refresh.png?rand=20180622">-->
        立即用车
    </div>
    <img style="width:30px; height:30px; position:fixed;right: 8px;bottom: 130px;" id="user_location_self"
         src="http://img.youchedongli.cn/public/static/mobile/images/location_marker_self.png?rand=20180622"/>
    <img style="width:30px; height:30px; position:fixed;right: 8px;bottom: 85px;" id="js_goto_recommend"
         src="http://img.youchedongli.cn/public/static/mobile/images/build_point.png?rand=20180622"/>
    <a href="tel:{$service_phone}">
        <div style="width:30px; height:30px; position:fixed;right: 8px;bottom: 40px;background: #ffdb30;text-align:center;line-height: 30px;border-radius: 15px;color: #FFFFFF"
             class="mui-icon mui-icon-phone"></div>
    </a>
</div>
<script type="text/javascript" src="__STATIC__/mobile/js/jquery.min.js"></script>
<script type="text/javascript" src="__STATIC__/mobile/js/gps-transform-js.js?rand={$js_rand}"></script>
<script type="text/javascript" src="__STATIC__/mobile/js/public-js.js?rand={$js_rand}"></script>
<script type="text/javascript"
        src="http://api.map.baidu.com/api?v=2.0&ak=84chcOlNtuGKpKkIfp0oprKRveLSXEnj"></script>
<script type="text/javascript" src="__STATIC__/mobile/js/baidu/TextIconOverlay.js?rand={$css_rand}"></script>
<script type="text/javascript" src="__STATIC__/mobile/js/baidu/MarkerClusterer.js?rand={$css_rand}"></script>
<script type="text/javascript" src="__STATIC__/mui/js/mui.min.js?rand={$css_rand}"></script>
<script type="text/javascript" src="__STATIC__/mobile/js/map-choose-car-js.js?rand={$js_rand}"></script>

{if condition="$is_wxBrowser eq 'yes'"}
<script src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js?rand={$js_rand}"></script>
<script>
    /*
     * 注意：
     * 1. 所有的JS接口只能在公众号绑定的域名下调用，公众号开发者需要先登录微信公众平台进入“公众号设置”的“功能设置”里填写“JS接口安全域名”。
     * 2. 如果发现在 Android 不能分享自定义内容，请到官网下载最新的包覆盖安装，Android 自定义分享接口需升级至 6.0.2.58 版本及以上。
     * 3. 常见问题及完整 JS-SDK 文档地址：http://mp.weixin.qq.com/wiki/7/aaa137b55fb2e0456bf8dd9148dd613f.html
     *
     * 开发中遇到问题详见文档“附录5-常见错误及解决办法”解决，如仍未能解决可通过以下渠道反馈：
     * 邮箱地址：weixin-open@qq.com
     * 邮件主题：【微信JS-SDK反馈】具体问题
     * 邮件内容说明：用简明的语言描述问题所在，并交代清楚遇到该问题的场景，可附上截屏图片，微信团队会尽快处理你的反馈。
     */
    wx.config({
        debug: false,
        appId: "{$jssdk['appid']}",
        timestamp: "{$jssdk['timestamp']}",
        nonceStr: "{$jssdk['nonceStr']}",
        signature: "{$jssdk['signature']}",
        jsApiList: [
            'checkJsApi',
            'openLocation',
            'getLocation',
            'chooseImage',
            'uploadImage'
        ]
    });

    wx.ready(function (res) {
        if (marker_self != null) {
            marker_self.remove();
        }
        weixinLocation(true);
    });

    wx.error(function (res) {
        alert(JSON.stringify(res));
    });
</script>
<script>

    /**
     * 调用第三方导航软件实现导航
     * @param lat  目的地纬度
     * @param lng  目的地经度
     */
    function go_openLocation(lat, lng) {
        var ponitx = wgs2gcj(lat, lng);//将gps坐标转为百度地图坐标
        wx.openLocation({
            latitude: ponitx[0], // 纬度，浮点数，范围为90 ~ -90
            longitude: ponitx[1], // 经度，浮点数，范围为180 ~ -180。
            name: '取车地址', // 位置名
            address: '请按照导航去取用该车辆', // 地址详情说明
            scale: 18, // 地图缩放级别,整形值,范围从1~28。默认为最大
            infoUrl: '' // 在查看位置界面底部显示的超链接,可点击跳转
        });
    }

    //微信定位
    function weixinLocation(is_get_car) {
        wx.getLocation({
            success: function (res) {
                is_up_location = true;
                var latitude = res.latitude; //纬度
                var longitude = res.longitude; //经度
                localStorage.setItem("old_marker_self_lat", latitude);
                localStorage.setItem("old_marker_self_lng", longitude);
                var pointx = wgs2bd(parseFloat(latitude), parseFloat(longitude));
                if (marker_self != null) {
                    marker_self.remove();
                }
                var points = new BMap.Point(pointx[1], pointx[0]);
                localStorage.setItem("marker_self_lat", points.lat);
                localStorage.setItem("marker_self_lng", points.lng);
                var myIcon;
                myIcon = new BMap.Icon("http://img.youchedongli.cn/public/static/mobile/images/marker_self.png", new BMap.Size(20, 20));
                marker_self = new BMap.Marker(points, {icon: myIcon});
                map.addOverlay(marker_self);
                map.setCenter(points);
                if (is_get_car) {
                    setTimeout(function () {
                        get_car_list();
                        $('#js_search_plate').removeAttr("disabled");
                    }, 1000);
                }
            },
            cancel: function (res) {
                // alert('用户拒绝授权获取地理位置');
            },
            fail: function (res) {
//                alert(JSON.stringify(res));
            }
        });
    }

    function take_plate_pic() {

        wx.chooseImage({
            count: 1, // 默认9
            sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
            sourceType: ['camera'], // 调用相机拍照
            // sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
            success: function (res) {
                var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                wx.uploadImage({
                    localId: localIds[0] + '',
                    isShowProgressTips: 1,
                    success: function (res) {
                        upload_plate_pic(res.serverId);
                    },
                    fail: function (res) {
                        alert("上传失败" + res.errMsg);
                    }
                });
            },
            cancel: function (res) {

            },
            fail: function (res) {
                alert(JSON.stringify(res));
            }
        });
    }

    function upload_plate_pic(serverId) {
        $.ajax({
            url: website + "/api/Common/license_plate.html",
            type: "POST",
            async: true,
            data: {
                serverId: serverId,
                url: ""
            },
            timeout: 5000,
            dataType: "json",
            beforeSend: function (xhr) {

            },
            success: function (data) {
                var code = data.code;
                var data = data.data;

                if (parseInt(code) == 0) {
                    //var color = data.color;//车牌颜色
                    var number = data.number;//车牌号
                    $("#js_search_plate").focus();
                    $("#js_search_plate").val(data.number);
                    getStoreByLicense(number);
                } else {
                    Toast("识别错误", 2000);
					$("#js_marker_car_pop").fadeOut(500);
                }

            },
            error: function (xhr, textStatus) {

            },
            complete: function () {

            }
        });
    }
</script>
{/if}
</body>
</html>