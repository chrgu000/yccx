{extend name="base" /}
{block name="css"}
<link rel="stylesheet" href="__STATIC__/mui/css/mui.min.css?rand={$css_rand}">
<link rel="stylesheet" href="__STATIC__/mui/css/mui-icons-extra.css?rand={$css_rand}">
<link rel="stylesheet" href="__STATIC__/mui/css/app-self.css?rand={$css_rand}">
{/block}
{block name="body"}
<style>

    .title {
        margin: 20px 15px 10px;
        color: #6d6d72;
        font-size: 15px;
    }

    .oa-contact-cell.mui-table .mui-table-cell {
        padding: 11px 0;
        vertical-align: middle;
    }

    .oa-contact-cell {
        position: relative;
        margin: -11px 0;
    }

    .oa-contact-avatar {
        width: 75px;
    }

    .oa-contact-avatar img {
        border-radius: 50%;
    }

    .oa-contact-content {
        width: 100%;
    }

    .oa-contact-name {
        margin-right: 20px;
    }

    .oa-contact-name, oa-contact-position {
        float: left;
    }

    .mui-control-content {
        background-color: white;
        height: 100%;
    }

    .mui-control-content .mui-loading {
        margin-top: 50px;
    }

    .mui-table-view-cell {
        padding: 5px 8px;
    }

    .mui-table-view-cell .mui-media-object {
        margin-top: 3%;
        margin-right: 12%
    }

    html {
        height: 100%;
    }

    .mui-slider-img-content {
        position: absolute;
        bottom: 10px;
        left: 10px;
        right: 10px;
        color: white;
        text-align: center;
        line-height: 21px
    }

    .mui-table-view.mui-grid-view .mui-table-view-cell {
        padding: 5px 0 0 5px;
    }
</style>
<body style="height: 100%">
<div class="mui-navbar-inner mui-bar mui-bar-nav mui-navbar-center">
    <button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
        <span class="mui-icon mui-icon-left-nav"></span>
    </button>
    <h1 class="mui-center mui-title">车辆维护中</h1>
</div>
<div class="mui-content" id="page_div" style="height: 100%;">
    <div id="take_task_div" class="mui-content" style="text-align: center;">
        <div class="mui-content">
            <ul class="mui-table-view mui-grid-view js_car_pic_choose" style="margin-top: 0px">
                <li class="mui-table-view-cell mui-media mui-col-xs-4" style="text-align: center">
                    <img class="mui-media-object" id="js_last_pic_left_front"
                         src="http://img.youchedongli.cn/public/static/mobile/images/car_pic_left_front.png?rand=2018"
                         style="height: 70px">
                </li>
                <li class="mui-table-view-cell mui-media mui-col-xs-4" style="text-align: center">
                    <img class="mui-media-object" id="js_last_pic_right_front"
                         src="http://img.youchedongli.cn/public/static/mobile/images/car_pic_left_front.png?rand=2018"
                         style="height: 70px">
                </li>
                <li class="mui-table-view-cell mui-media mui-col-xs-4" style="text-align: center">
                    <img class="mui-media-object" id="js_last_pic_car_back"
                         src="http://img.youchedongli.cn/public/static/mobile/images/car_pic_left_front.png?rand=2018"
                         style="height: 70px">
                </li>
            </ul>
        </div>
        <div class="mui-media-body" style="margin-top: 1px">维护前拍照</div>
        <div class="mui-content" style="background-color:#fff;">
            <ul id="js_pic_parent1" class="mui-table-view mui-grid-view js_car_pic_choose" style="margin-top: 0px;">
                <li class="mui-table-view-cell mui-media mui-col-xs-6">
                    <img id="js_pic_left_front1" class="mui-media-object"
                         data-picUrl="http://img.youchedongli.cn/public/static/mobile/images/car_pic_left_front.png"
                         src="http://img.youchedongli.cn/public/static/mobile/images/car_pic_left_front.png?rand=2018"
                         style="height: 100px">
                    <div class="mui-media-body">左前</div>
                </li>
                <li class="mui-table-view-cell mui-media mui-col-xs-6">
                    <img id="js_pic_right_front1" class="mui-media-object"
                         data-picUrl="http://img.youchedongli.cn/public/static/mobile/images/car_pic_right_front.png"
                         src="http://img.youchedongli.cn/public/static/mobile/images/car_pic_right_front.png?rand=2018"
                         style="height: 100px">
                    <div class="mui-media-body">右前</div>
                </li>
                <li class="mui-table-view-cell mui-media mui-col-xs-6">
                    <img id="js_pic_back1" class="mui-media-object"
                         data-picUrl="http://img.youchedongli.cn/public/static/mobile/images/car_pic_back.png"
                         src="http://img.youchedongli.cn/public/static/mobile/images/car_pic_back.png?rand=2018"
                         style="height: 100px">
                    <div class="mui-media-body">后方</div>
                </li>
            </ul>
        </div>
        <div class="mui-row" style="padding: 10px 0">
            <div class="mui-col-xs-4 mui-col-sm-4">
                <span class="mui-badge mui-badge-primary">车型：<span id="cartype_name"></span></span>
            </div>
            <div class="mui-col-xs-4 mui-col-sm-4">
                <span class="mui-badge mui-badge-success">车牌：<span id="licence_plate"></span></span>
            </div>
            <div class="mui-col-xs-4 mui-col-sm-4">
                <span class="mui-badge mui-badge-purple">续航：<span id="driving_mileage"></span></span>
            </div>
        </div>
        <div class="mui-row" style="width: 100%;margin-top: 10px">
            <div class="mui-col-xs-4 mui-col-sm-4" style="text-align: center">
                <button id="order_begin" type="button" class="mui-btn-yellow">
                    开始维护
                </button>
            </div>
            <div class="mui-col-xs-4 mui-col-sm-4" style="text-align: center">
                <button type="button" class="mui-btn-danger car-cmd-btn" data-cmd="7">立即寻车</button>
            </div>
            <div class="mui-col-xs-4 mui-col-sm-4" style="text-align: center">
                <button type="button" id="js_car_navi" class="mui-btn-danger">导航取车</button>
            </div>
        </div>
        <div class="mui-row" style="width: 100%;height: 60px">
        </div>
    </div>
</div>
<script type="text/javascript" src="__STATIC__/mui/js/mui.min.js"></script>
<script type="text/javascript" src="__STATIC__/mui/js/mui.previewimage.js?rand={$js_rand}"></script>
<script type="text/javascript" src="__STATIC__/mui/js/mui.zoom.js?rand={$js_rand}"></script>
{if condition="$is_wxBrowser eq 'yes'"}
<script src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js?rand={$js_rand}"></script>
<script>
    var is_up_end = true;
    /*
     * 注意：
     * 1. 所有的JS接口只能在公众号绑定的域名下调用，公众号开发者需要先登录微信公众平台进入“公众号设置”的“功能设置”里填写“JS接口安全域名”。
     * 2. 如果发现在 Android 不能分享自定义内容，请到官网下载最新的包覆盖安装，Android 自定义分享接口需升级至 6.0.2.58 版本及以上。
     * 3. 常见问题及完整 JS-SDK 文档地址：http://mp.weixin.qq.com/wiki/7/aaa137b55fb2e0456bf8dd9148dd613f.html
     *
     * 开发中遇到问题详见文档“附录5-常见错误及解决办法”解决，如仍未能解决可通过以下渠道反馈：
     * 邮箱地址：weixin-open@qq.com
     * 邮件主题：【微信JS-SDK反馈】具体问题
     * 邮件内容说明：用简明的语言描述问题所在，并交代清楚遇到该问题的场景，可附上截屏图片，微信团队会尽快处理你的反馈。
     */
    wx.config({
        debug: false,
        appId: "{$jssdk['appid']}",
        timestamp: "{$jssdk['timestamp']}",
        nonceStr: "{$jssdk['nonceStr']}",
        signature: "{$jssdk['signature']}",
        jsApiList: [
            'checkJsApi',
            'openLocation',
            'chooseImage',
            'uploadImage'
        ]
    });
    wx.ready(function () {
        var use_pic_img = $("#js_pic_parent").find("img");
        use_pic_img.on("click", function () {
            take_user_pic($(this).attr("id"), "task", "");
            return false;
        });
        var use_pic_img1 = $("#js_pic_parent1").find("img");
        use_pic_img1.on("click", function () {
            take_user_pic($(this).attr("id"), "task", "");
            return false;
        });
    });
    wx.error(function (res) {
        //alert(res.errMsg);
    });

    function take_user_pic(viewId, path, field) {
        if (!is_up_end) {
            return;
        }
        wx.chooseImage({
            count: 1, // 默认9
            sizeType: ['compressed'], // 可以指定是原图还是压缩图，默认二者都有
            sourceType: ['camera'], // 调用相机拍照
            // sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
            success: function (res) {
                var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                // $("#" + viewId).attr('src', localIds[0]);
                is_up_end = false;
                wx.uploadImage({
                    localId: localIds[0] + '',
                    isShowProgressTips: 1,
                    success: function (res) {
                        upload_use_car_pic(viewId, res.serverId, "jpg", path, field);
                    },
                    fail: function (res) {
                        is_up_end = true;
                        mui.alert("上传失败" + res.errMsg, '提示');
                    }
                });
            },
            cancel: function (res) {
            },
            fail: function (res) {
            }
        });
    }

    function upload_use_car_pic(viewId, localIds, type, path, field) {
        $.ajax({
            url: website + "/api/Dynupload/upload.html",
            type: "POST",
            async: true,
            data: {
                sid: localIds,
                type: type,
                path: path,
                field: field
            },
            timeout: 5000,
            dataType: "json",
            success: function (data) {
                is_up_end = true;
                if (data.code == 0) {
                    $("#" + viewId).attr('src', "http://img.youchedongli.cn" + data.url);
                    $("#" + viewId).attr('data-picUrl', "http://img.youchedongli.cn" + data.url);
                } else {
                    Toast(data.info, 2000);
                }
            },
            error: function (xhr, textStatus) {
                is_up_end = true;
            }
        });
    }
</script>
{/if}
<script>
    var order_id = {$order_id};
    var car_id = {$car_id};
    mui.init({
        swipeBack: true//启用右滑关闭功能，
    });
    mui.previewImage();
    /**
     * 开始取车任务
     */
    $("#order_begin").on('click', function () {
        acquire_task();
    });

    function acquire_task() {
        var pic_error = ["左前", "右前", "后方"];
        var acquire_img = new Array();
        var flag = false;
        var use_pic_img = $("#js_pic_parent1").find("img");
        for (var i = 0; i < use_pic_img.length; i++) {
            if (use_pic_img.eq(i).attr("data-picUrl") == "") {
                mui.alert(pic_error[i] + "图片为空", '提示');
                flag = false;
                return;
            } else {
                acquire_img[i] = $(use_pic_img[i]).attr("data-picUrl");
                flag = true;
            }
        }
        if (flag) {
            $.ajax({
                url: website + "/api/operation_car/acquire_order_operation.html",
                type: "POST",
                async: true,
                data: {
                    order_id: order_id,
                    acquire_img: acquire_img
                },
                outTime: 5000,
                dataType: "json",
                success: function (data_temp) {
                    // console.log("成功");
                    if (parseInt(data_temp.code) === 0) {
                        window.location.href = "task_end.html?goods_id=" + car_id;
                    } else {
                        mui.alert(data_temp.info, '提示');
                    }
                }
            });
        }
    }

    /**
     * 获取车辆信息
     */
    function get_car_task_info(goods_id) {
        $.ajax({
            url: website + "/api/Car/get_car_id_task.html",
            type: "POST",
            async: true,
            data: {
                id: goods_id
            },
            outTime: 5000,
            dataType: "json",
            success: function (data_temp) {
                // console.log("成功");
                if (parseInt(data_temp.code) === 0) {
                    $("#cartype_name").text(data_temp.data.cartype_name);
                    $("#licence_plate").text("(" + data_temp.data.licence_plate + ")");
                    $("#driving_mileage").text("(" + data_temp.data.driving_mileage + "km)");
                    $("#js_car_navi").attr("data-lat", data_temp.data.location_latitude);
                    $("#js_car_navi").attr("data-lng", data_temp.data.location_longitude);
                    getPicLastOrder(goods_id);
                }
            }
        });
    }

    //获取上一个订单还车时拍的照片
    function getPicLastOrder(goods_id) {
        $.ajax({
            url: website + "/api/Order/get_car_order_img.html",
            type: "GET",
            async: true,
            data: {
                goods_id: goods_id
            },
            timeout: 5000,
            dataType: "json",
            success: function (data) {
                if (parseInt(data.code) == 0) {
                    var data = data.data;
                    $("#js_last_pic_left_front").attr("src", data.left_front);
                    $("#js_last_pic_left_front").attr("data-preview-src", data.left_front);
                    $("#js_last_pic_left_front").attr("data-preview-group", "pic_last_order");

                    $("#js_last_pic_right_front").attr("src", data.right_front);
                    $("#js_last_pic_right_front").attr("data-preview-src", data.left_front);
                    $("#js_last_pic_right_front").attr("data-preview-group", "pic_last_order");

                    $("#js_last_pic_car_back").attr("src", data.car_back);
                    $("#js_last_pic_car_back").attr("data-preview-src", data.left_front);
                    $("#js_last_pic_car_back").attr("data-preview-group", "pic_last_order");
                }
            }
        });
    }

    /**
     * 调用第三方导航软件实现导航
     * @param lat  目的地纬度
     * @param lng  目的地经度
     */
    function go_openLocation(lat, lng) {
        var ponitx = wgs2gcj(lat, lng);//将gps坐标转为百度地图坐标
        wx.openLocation({
            latitude: ponitx[0], // 纬度，浮点数，范围为90 ~ -90
            longitude: ponitx[1], // 经度，浮点数，范围为180 ~ -180。
            name: '车辆位置', // 位置名
            address: '请按照导航去取车', // 地址详情说明
            scale: 18, // 地图缩放级别,整形值,范围从1~28。默认为最大
            infoUrl: '' // 在查看位置界面底部显示的超链接,可点击跳转
        });
    }

    var in_cmd = true;
    /**
     * 执行车辆控制操作
     */
    $(".car-cmd-btn").on("click", function () {
        var cmd = $(this).attr("data-cmd");
        var btnArray = ['否', '确认'];
        mui.confirm('确定要执行操作吗？', '消息提醒', btnArray, function (e) {
            if (e.index == 1) {
                car_cmd(cmd);
            }
        })
    });

    function car_cmd(cmd_type) {
        if (!in_cmd) {
            return;
        }
        in_cmd = false;
        $.ajax({
            url: website + "/api/operation_car/car_cmd.html",
            type: "GET",
            async: true,
            data: {
                order_id: order_id,
                cmd: cmd_type
            },
            outTime: 10000,
            dataType: "json",
            success: function (data_temp) {
                in_cmd = true;
                mui.alert(data_temp.info, '消息提示');
            }, error: function () {
                alert("失败");
                in_cmd = true;
            }
        });
    }

    //导航
    $("#js_car_navi").on("click", function () {
        var navi_lat = $(this).attr("data-lat");
        var navi_lng = $(this).attr("data-lng");
        go_openLocation(parseFloat(navi_lat), parseFloat(navi_lng));
    });

    get_car_task_info(car_id);

    //物理返回按钮
    // pushHistory();//进栈
    //物理返回键的点击事件监听
    window.addEventListener("popstate", function (e) {
        // alert("1");
        if (document.querySelector(".mui-preview-in")) {
            mui.previewImage().close();
            // pushHistory();
        } else {
            window.history.back();
        }
    }, false);
</script>
</body>
{/block}

